apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  annotations:
    chart2kro.dev/generated: "true"
  labels:
    app.kubernetes.io/managed-by: chart2kro
    app.kubernetes.io/name: with-database
    app.kubernetes.io/version: 1.0.0
  name: with-database
spec:
  resources:
  - id: deployment
    readyWhen:
    - ${self.status.availableReplicas == self.status.replicas}
    template:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: release-webapp
        namespace: default
      spec:
        replicas: ${schema.spec.replicaCount}
        selector:
          matchLabels:
            app: webapp
        template:
          metadata:
            labels:
              app: webapp
          spec:
            containers:
            - env:
              - name: DB_HOST
                value: release-postgresql
              - name: DB_PORT
                value: "5432"
              image: ${schema.spec.image.repository}:${schema.spec.image.tag}
              name: webapp
              ports:
              - containerPort: ${schema.spec.service.port}
  - dependsOn:
    - deployment
    id: service
    readyWhen:
    - ${self.spec.clusterIP != ""}
    template:
      apiVersion: v1
      kind: Service
      metadata:
        name: release-webapp
        namespace: default
      spec:
        ports:
        - port: ${schema.spec.service.port}
          targetPort: ${schema.spec.service.port}
        selector:
          app: webapp
        type: ClusterIP
  schema:
    apiVersion: with-database.kro.run/v1alpha1
    kind: WithDatabase
    spec:
      image:
        repository: string | default="myapp"
        tag: string | default="2.0"
      replicaCount: integer | default=1
      service:
        port: integer | default=8080
    status:
      deploymentAvailableReplicas: ${deployment.status.availableReplicas}
      deploymentReadyReplicas: ${deployment.status.readyReplicas}
      serviceClusterIP: ${service.spec.clusterIP}
      serviceLoadBalancerIP: ${service.status.loadBalancer.?ingress[0].?ip}
